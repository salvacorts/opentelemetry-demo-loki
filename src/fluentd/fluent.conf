<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter docker.**>
  @type record_transformer
  enable_ruby
  <record>
    # Use the container name as the service label (removing the leading slash)
    service ${record["container_name"].gsub("/", "")}
  </record>
  # Drop keys from input docker json format, so the output only contains the log message
  # E.g. input --> {"container_id":"1234", "container_name":"/container_name", "source":"stdout", "log":"log message"}
  #      output --> {"log":"log message"}
  remove_keys container_id, container_name, source
</filter>

<match docker.**>
  @type loki
  url http://loki:3100
  <label>
    service
  </label>
  # Flatten the input json record to a string with the actual log message
  # E.g. input --> {"log":"log message"}
  #      output --> "log message"
  drop_single_key true
  <buffer>
    flush_interval 10s
    flush_at_shutdown true
  </buffer>
</match>
